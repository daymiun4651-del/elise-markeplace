<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elise Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        // Check if Firebase loaded
        window.firebaseLoaded = typeof firebase !== 'undefined';
    </script>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 py-2 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-full">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
                    </svg>
                </div>
                <span class="text-xl font-bold text-gray-900">Elise Marketplace</span>
            </div>
            
            <div class="flex-1 max-w-xl mx-8">
                <div class="relative">
                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
                    </svg>
                    <input
                        type="text"
                        id="searchInput"
                        placeholder="Search Marketplace"
                        class="w-full pl-10 pr-4 py-2 bg-gray-100 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                </div>
            </div>
            
            <div class="w-9 h-9 bg-blue-100 rounded-full flex items-center justify-center">
                <span class="text-sm font-semibold text-blue-600">E</span>
            </div>
        </div>
    </header>

    <div class="flex">
        <!-- Sidebar -->
        <aside class="w-80 bg-white h-[calc(100vh-56px)] sticky top-14 overflow-y-auto border-r border-gray-200 hidden lg:block">
            <div class="p-4">
                <h2 class="text-2xl font-bold text-gray-900 mb-1">Buy Elise's Things</h2>
                <p class="text-sm text-gray-500 mb-4">Unique items looking for new homes</p>
                
                <div class="flex items-center gap-2 text-sm text-gray-600 mb-6 p-2 bg-gray-50 rounded-lg">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
                    </svg>
                    <span>New York City ¬∑ 40 mi</span>
                </div>
                
                <div class="border-t border-gray-200 pt-4">
                    <h3 class="text-sm font-semibold text-gray-500 mb-3 px-2">Recent Activity</h3>
                    <div id="bidHistory" class="space-y-2 max-h-64 overflow-y-auto">
                        <p class="text-xs text-gray-400 px-2">No bids yet</p>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6">
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-1">Today's picks</h3>
                <p class="text-sm text-gray-500" id="itemCount">Loading...</p>
            </div>
            
            <div id="itemsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <!-- Items will be loaded here -->
                <div class="text-center py-12">
                    <div class="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                    <p class="text-gray-600">Loading marketplace...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Bid Modal -->
    <div id="bidModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg max-w-lg w-full overflow-hidden">
            <div id="modalContent">
                <!-- Modal content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDSB58hz3gNRJyiQ5bbLZx6XkC7iO8gh4Q",
            authDomain: "elise-marketplace.firebaseapp.com",
            projectId: "elise-marketplace",
            storageBucket: "elise-marketplace.firebasestorage.app",
            messagingSenderId: "539976921600",
            appId: "1:539976921600:web:8f463cd1b0e54d4115dee5"
        };

        let db = null;

        // Default items
        const defaultItems = [
            {
                id: "phone",
                name: "Elise's Phone",
                description: "Well-used smartphone. Some scratches on the screen but works perfectly. Comes with original box.",
                image: "üì±",
                currentBid: 0,
                minIncrement: 10,
                bidCount: 0,
                endTime: "2025-12-25T18:00:00",
                category: "Electronics",
                location: "Manhattan, NY",
                highestBidder: null
            },
            {
                id: "charger",
                name: "Elise's Charger",
                description: "Fast charging USB-C charger with cable. Works great, just upgraded to a new one.",
                image: "üîå",
                currentBid: 0,
                minIncrement: 2,
                bidCount: 0,
                endTime: "2025-12-24T12:00:00",
                category: "Electronics",
                location: "Manhattan, NY",
                highestBidder: null
            },
            {
                id: "laptop",
                name: "Elise's Laptop",
                description: "Reliable laptop, great for everyday use. Minor wear on the keys but runs smoothly.",
                image: "üíª",
                currentBid: 0,
                minIncrement: 25,
                bidCount: 0,
                endTime: "2025-12-26T18:00:00",
                category: "Electronics",
                location: "Manhattan, NY",
                highestBidder: null
            },
            {
                id: "dad-plate",
                name: "Elise's #1 Dad License Plate",
                description: "New York Empire State novelty license plate. Perfect for any dad's man cave!",
                image: "üè∑Ô∏è",
                currentBid: 0,
                minIncrement: 5,
                bidCount: 0,
                endTime: "2025-12-25T18:00:00",
                category: "Home Decor",
                location: "Manhattan, NY",
                highestBidder: null
            },
            {
                id: "mouse",
                name: "Elise's Mouse",
                description: "Wireless mouse with ergonomic design. Smooth scrolling, batteries included.",
                image: "üñ±Ô∏è",
                currentBid: 0,
                minIncrement: 3,
                bidCount: 0,
                endTime: "2025-12-23T15:00:00",
                category: "Electronics",
                location: "Manhattan, NY",
                highestBidder: null
            },
            {
                id: "keyboard",
                name: "Elise's Keyboard",
                description: "Mechanical keyboard with RGB lighting. Satisfying clicks, great for typing.",
                image: "‚å®Ô∏è",
                currentBid: 0,
                minIncrement: 5,
                bidCount: 0,
                endTime: "2025-12-24T16:00:00",
                category: "Electronics",
                location: "Manhattan, NY",
                highestBidder: null
            },
            {
                id: "chair",
                name: "Elise's Chair",
                description: "Comfortable office chair with adjustable height and lumbar support. Some wear on armrests.",
                image: "ü™ë",
                currentBid: 0,
                minIncrement: 10,
                bidCount: 0,
                endTime: "2025-12-27T18:00:00",
                category: "Home Decor",
                location: "Manhattan, NY",
                highestBidder: null
            },
            {
                id: "desk",
                name: "Elise's Desk",
                description: "Spacious desk with cable management. Perfect for home office setup. Local pickup only.",
                image: "üñ•Ô∏è",
                currentBid: 0,
                minIncrement: 15,
                bidCount: 0,
                endTime: "2025-12-28T18:00:00",
                category: "Home Decor",
                location: "Manhattan, NY",
                highestBidder: null
            },
            {
                id: "laptop-stand",
                name: "Elise's Laptop Stand",
                description: "Adjustable aluminum laptop stand. Improves posture and airflow. Like new condition.",
                image: "üìê",
                currentBid: 0,
                minIncrement: 5,
                bidCount: 0,
                endTime: "2025-12-22T14:00:00",
                category: "Electronics",
                location: "Manhattan, NY",
                highestBidder: null
            }
        ];

        let items = [];
        let selectedItem = null;

        // Format time left
        function formatTimeLeft(endTime) {
            const end = new Date(endTime);
            const now = new Date();
            const diff = end - now;
            if (diff <= 0) return "Ended";
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            if (days > 0) return `${days}d ${hours}h left`;
            return `${hours}h left`;
        }

        // Format timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            return new Intl.DateTimeFormat('en-US', {
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            }).format(timestamp);
        }

        // Render items grid
        function renderItems() {
            const grid = document.getElementById('itemsGrid');
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            
            const filteredItems = items.filter(item => 
                item.name.toLowerCase().includes(searchQuery)
            );

            document.getElementById('itemCount').textContent = `${filteredItems.length} items available`;

            if (filteredItems.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 col-span-full text-center py-8">No items found</p>';
                return;
            }

            grid.innerHTML = filteredItems.map(item => {
                // Check if image is a URL or emoji
                const isUrl = item.image && (item.image.startsWith('http') || item.image.startsWith('data:'));
                const imageContent = isUrl 
                    ? `<img src="${item.image}" alt="${item.name}" class="w-full h-full object-cover group-hover:scale-110 transition-transform" />`
                    : `<span class="text-6xl group-hover:scale-110 transition-transform">${item.image}</span>`;
                
                return `
                <div class="bg-white rounded-lg overflow-hidden hover:shadow-md transition-shadow cursor-pointer group" onclick="openBidModal('${item.id}')">
                    <div class="relative aspect-square bg-gray-100 flex items-center justify-center overflow-hidden">
                        ${imageContent}
                        <div class="absolute bottom-2 left-2 bg-black bg-opacity-70 text-white text-xs px-2 py-1 rounded flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                            </svg>
                            ${formatTimeLeft(item.endTime)}
                        </div>
                    </div>
                    <div class="p-3">
                        <p class="font-bold text-lg text-gray-900">$${item.currentBid}</p>
                        <p class="text-sm text-gray-800 line-clamp-2 leading-tight mt-1">${item.name}</p>
                        <p class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
                            </svg>
                            ${item.location} ¬∑ ${item.bidCount || 0} bids
                        </p>
                        ${item.highestBidder ? `<p class="text-xs text-blue-600 mt-1">Leading: ${item.highestBidder}</p>` : ''}
                    </div>
                </div>
            `}).join('');
        }

        // Render bid history
        function renderBidHistory(bids) {
            const container = document.getElementById('bidHistory');
            
            if (bids.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-400 px-2">No bids yet</p>';
                return;
            }

            container.innerHTML = bids.slice(0, 10).map(bid => `
                <div class="px-2 py-2 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-2">
                        <div class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center">
                            <svg class="w-3 h-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
                            </svg>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs font-medium text-gray-900 truncate">${bid.bidderName}</p>
                            <p class="text-xs text-gray-500">$${bid.amount} on ${bid.itemName}</p>
                        </div>
                    </div>
                    ${bid.timestamp ? `<p class="text-xs text-gray-400 mt-1 pl-8">${formatTimestamp(bid.timestamp)}</p>` : ''}
                </div>
            `).join('');
        }

        // Open bid modal
        function openBidModal(itemId) {
            selectedItem = items.find(i => i.id === itemId);
            if (!selectedItem) return;

            const modal = document.getElementById('bidModal');
            const content = document.getElementById('modalContent');
            const minBid = selectedItem.currentBid + selectedItem.minIncrement;
            
            // Check if image is a URL or emoji
            const isUrl = selectedItem.image && (selectedItem.image.startsWith('http') || selectedItem.image.startsWith('data:'));
            const imageContent = isUrl 
                ? `<img src="${selectedItem.image}" alt="${selectedItem.name}" class="w-full h-full object-cover rounded-lg" />`
                : `<span class="text-4xl">${selectedItem.image}</span>`;

            content.innerHTML = `
                <div class="flex items-center justify-between p-4 border-b border-gray-200">
                    <h3 class="text-lg font-bold text-gray-900">Place a Bid</h3>
                    <button onclick="closeModal()" class="p-1 hover:bg-gray-100 rounded-full">
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                        </svg>
                    </button>
                </div>
                
                <div class="p-4 bg-gray-50 border-b border-gray-200">
                    <div class="flex items-center gap-4">
                        <div class="w-20 h-20 bg-white rounded-lg flex items-center justify-center overflow-hidden">
                            ${imageContent}
                        </div>
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900">${selectedItem.name}</h4>
                            <p class="text-sm text-gray-500 flex items-center gap-1 mt-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
                                </svg>
                                ${selectedItem.location}
                            </p>
                            <div class="flex items-center gap-4 mt-2">
                                <span class="text-lg font-bold text-gray-900">$${selectedItem.currentBid}</span>
                                <span class="text-sm text-gray-500">${selectedItem.bidCount || 0} bids</span>
                            </div>
                            ${selectedItem.highestBidder ? `<p class="text-xs text-blue-600 mt-1">Current leader: ${selectedItem.highestBidder}</p>` : ''}
                        </div>
                    </div>
                </div>
                
                <div class="p-4 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
                        <input
                            type="text"
                            id="bidderName"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                            placeholder="Enter your name"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Your Bid (min $${minBid})</label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">$</span>
                            <input
                                type="number"
                                id="bidAmount"
                                value="${minBid}"
                                min="${minBid}"
                                step="${selectedItem.minIncrement}"
                                class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                            />
                        </div>
                    </div>
                </div>
                
                <div class="p-4 border-t border-gray-200 flex gap-2">
                    <button onclick="closeModal()" class="flex-1 bg-gray-100 text-gray-700 py-2 px-4 rounded-md font-semibold hover:bg-gray-200 transition-colors text-sm">
                        Cancel
                    </button>
                    <button onclick="placeBid()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 transition-colors text-sm">
                        Place Bid
                    </button>
                </div>
            `;

            modal.classList.remove('hidden');
        }

        // Close modal
        function closeModal() {
            document.getElementById('bidModal').classList.add('hidden');
            selectedItem = null;
        }

        // Show success message
        function showSuccess() {
            const content = document.getElementById('modalContent');
            content.innerHTML = `
                <div class="text-center py-12 px-6">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                            <path d="M20 6 9 17l-5-5"/>
                        </svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Bid Placed!</h3>
                    <p class="text-gray-500">You're now the highest bidder</p>
                </div>
            `;
            setTimeout(closeModal, 2000);
        }

        // Place bid
        async function placeBid() {
            if (!selectedItem) return;

            const bidderName = document.getElementById('bidderName').value.trim();
            const bidAmount = parseFloat(document.getElementById('bidAmount').value);
            const minBid = selectedItem.currentBid + selectedItem.minIncrement;

            if (!bidderName) {
                alert('Please enter your name');
                return;
            }

            if (bidAmount < minBid) {
                alert(`Minimum bid is $${minBid}`);
                return;
            }

            try {
                // Add bid to bids collection
                await db.collection('bids').add({
                    itemId: selectedItem.id,
                    itemName: selectedItem.name,
                    bidderName: bidderName,
                    amount: bidAmount,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Update item
                await db.collection('items').doc(selectedItem.id).update({
                    currentBid: bidAmount,
                    bidCount: (selectedItem.bidCount || 0) + 1,
                    highestBidder: bidderName
                });

                showSuccess();
            } catch (error) {
                console.error("Error placing bid:", error);
                alert("Error placing bid: " + error.message);
            }
        }

        // Initialize
        async function init() {
            try {
                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();

                // Initialize items if they don't exist
                for (const item of defaultItems) {
                    const itemRef = db.collection('items').doc(item.id);
                    const itemSnap = await itemRef.get();
                    if (!itemSnap.exists) {
                        await itemRef.set(item);
                    }
                }

                // Subscribe to items
                db.collection('items').onSnapshot((snapshot) => {
                    items = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    renderItems();
                }, (err) => {
                    console.error("Error:", err);
                    document.getElementById('itemsGrid').innerHTML = `
                        <div class="col-span-full text-center py-8">
                            <p class="text-red-500 font-semibold">Error loading items</p>
                            <p class="text-sm text-gray-500 mt-2">${err.message}</p>
                        </div>
                    `;
                });

                // Subscribe to bids
                db.collection('bids').orderBy('timestamp', 'desc').onSnapshot((snapshot) => {
                    const bids = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        timestamp: doc.data().timestamp?.toDate()
                    }));
                    renderBidHistory(bids);
                });

            } catch (err) {
                console.error("Error:", err);
                document.getElementById('itemsGrid').innerHTML = `
                    <div class="col-span-full text-center py-8">
                        <p class="text-red-500 font-semibold">Error initializing</p>
                        <p class="text-sm text-gray-500 mt-2">${err.message}</p>
                    </div>
                `;
            }
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', renderItems);

        // Start the app when DOM is ready
        if (typeof firebase !== 'undefined') {
            init();
        } else {
            document.getElementById('itemsGrid').innerHTML = `
                <div class="col-span-full text-center py-8">
                    <p class="text-red-500 font-semibold">Error: Firebase not loaded</p>
                    <p class="text-sm text-gray-500 mt-2">This file needs to be hosted on a web server (like GitHub Pages) to work properly.</p>
                    <p class="text-sm text-gray-500 mt-1">Upload it to GitHub Pages and try again.</p>
                </div>
            `;
        }
    </script>
</body>
</html>
